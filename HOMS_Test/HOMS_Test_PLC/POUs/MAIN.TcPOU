<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4020.14">
  <POU Name="Main" Id="{d73f6033-1c1a-47a8-be0f-3a700ab10cd1}" SpecialFunc="None">
    <Declaration><![CDATA[PROGRAM Main
VAR
    M3: DUT_MotionStage; // Yup
	{attribute 'pytmc' := '
	  pv: AXISYUP
	'}
	fbMotionStage_y_up : FB_MotionStage;

	M4: DUT_MotionStage; // Ydwn
	{attribute 'pytmc' := '
	  pv: AXISYDWN
	'}
	fbMotionStage_y_dwn : FB_MotionStage;

	M1: DUT_MotionStage:=(nCommand:=3); // Xup
	{attribute 'pytmc' := '
	  pv: AXISXUP
	'}
	fbMotionStage_x_up : FB_MotionStage;

	M2: DUT_MotionStage:=(nCommand:=3); // Xdwn
	{attribute 'pytmc' := '
	  pv: AXISXDWN
	'}
	fbMotionStage_x_dwn : FB_MotionStage;

	M5: DUT_MotionStage:=(nCommand:=3); // PitchCoarse
	{attribute 'pytmc' := '
	  pv: AXISPITCH
	'}
	fbMotionStage_pitch : FB_MotionStage;

	M6: DUT_MotionStage:=(nCommand:=3); // Bender
	{attribute 'pytmc' := '
	  pv: AXISBENDER
	'}
	fbMotionStage_bender : FB_MotionStage;

	{attribute 'pytmc' := '
	  pv: TEST:MAIN:STOENABLE
	  io: io
	'}
	stoEnable AT %I* : BOOL;

	x_up_enc  AT %I*: ST_RenishawAbsEnc;
	x_dwn_enc  AT %I*: ST_RenishawAbsEnc;	
	y_up_enc  AT %I*: ST_RenishawAbsEnc;
	y_dwn_enc  AT %I*: ST_RenishawAbsEnc:=(Ref:=0);

	// Auto coupling function block
	fbAutoCoupleX : FB_GantryAutoCoupling;
	fbAutoCoupleY : FB_GantryAutoCoupling;

	bExecuteCoupleX : BOOL;
	bExecuteCoupleY : BOOL;
	bExecuteDecoupleX : BOOL;
	bExecuteDecoupleY : BOOL;
	bGantryAlreadyCoupledX : BOOL;
	bGantryAlreadyCoupledY : BOOL;
	
	// Gantry variables
//	fEncFudgeFactor : REAL := 1.005;
	nCurrGantryX : LINT;
	nCurrGantryY : LINT;
	nGantryTolX : LINT := 25000;
	nGantryTolY : LINT := 25000;
END_VAR]]></Declaration>
    <Implementation>
      <ST><![CDATA[M1.bLimitForwardEnable := TRUE;
M1.bLimitBackwardEnable := TRUE;
M1.bPowerSelf := TRUE;
M1.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

M2.bLimitForwardEnable := TRUE;
M2.bLimitBackwardEnable := TRUE;
M2.bPowerSelf := TRUE;
M2.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

M3.bLimitForwardEnable := TRUE;
M3.bLimitBackwardEnable := TRUE;
M3.bPowerSelf := TRUE;
M3.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

M4.bLimitForwardEnable := TRUE;
M4.bLimitBackwardEnable := TRUE;
M4.bPowerSelf := TRUE;
M4.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

M5.bLimitForwardEnable := TRUE;
M5.bLimitBackwardEnable := TRUE;
M5.bPowerSelf := TRUE;
M5.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

M6.bLimitForwardEnable := TRUE;
M6.bLimitBackwardEnable := TRUE;
M6.bPowerSelf := TRUE;
M6.nEnableMode := ENUM_StageEnableMode.STAGE_ENABLE_ALWAYS;

// Buttons to enable motors: write 0 to enable, 2 to disable
//M1.nEnableMode; // Yup
//M2.nEnableMode; // Ydwn
//M3.nEnableMode; // Xup
//M4.nEnableMode; // Xdwn
//M5.nEnableMode; // PitchCoarse
//M6.nEnableMode; // Bender

// Encoder Reference Values:
y_up_enc.Ref := 0;
y_dwn_enc.Ref := 0;
x_up_enc.Ref := 0; 
x_dwn_enc.Ref := 0;

// Pretend encoder counts
//y_up_enc.Count := LREAL_TO_ULINT(M1.stAxisStatus.fActPosition * fEncFudgeFactor * EXPT(10, 6));
//y_dwn_enc.Count := LREAL_TO_ULINT(M2.stAxisStatus.fActPosition * EXPT(10, 6));

//x_up_enc.Count := LREAL_TO_ULINT(M3.stAxisStatus.fActPosition * fEncFudgeFactor * EXPT(10, 6));
//x_dwn_enc.Count := LREAL_TO_ULINT(M4.stAxisStatus.fActPosition * EXPT(10, 6));

// Gantry Differences to monitor
//nCurrGantryY := ((ULINT_TO_LINT(y_up_enc.Count) - ULINT_TO_LINT(y_up_enc.Ref)) - (ULINT_TO_LINT(y_dwn_enc.Count) - ULINT_TO_LINT(y_dwn_enc.Ref)));
//nCurrGantryX := ((ULINT_TO_LINT(x_up_enc.Count) - ULINT_TO_LINT(x_up_enc.Ref)) - (ULINT_TO_LINT(x_dwn_enc.Count) - ULINT_TO_LINT(x_dwn_enc.Ref)));

//E-Stop
M1.bHardwareEnable := stoEnable;
M2.bHardwareEnable := stoEnable;
M3.bHardwareEnable := stoEnable;
M4.bHardwareEnable := stoEnable;
M5.bHardwareEnable := stoEnable;
M6.bHardwareEnable := stoEnable;

// Start Autocoupling
fbAutoCoupleX(nGantryTol:=nGantryTolX, Master:=M1, MasterEnc:=x_up_enc, Slave:=M2,
	          SlaveEnc:=x_dwn_enc, bExecuteCouple:=bExecuteCoupleX,
              bExecuteDecouple:=bExecuteDecoupleX,
              bGantryAlreadyCoupled=>bGantryAlreadyCoupledX);

fbAutoCoupleY(nGantryTol:=nGantryTolY, Master:=M3, MasterEnc:=y_up_enc, Slave:=M4,
	          SlaveEnc:=y_dwn_enc, bExecuteCouple:=bExecuteCoupleY,
              bExecuteDecouple:=bExecuteDecoupleY,
			  bGantryAlreadyCoupled=>bGantryAlreadyCoupledY);

fbMotionStage_y_up  (stMotionStage:=M3);
fbMotionStage_y_dwn (stMotionStage:=M4);
fbMotionStage_x_up  (stMotionStage:=M1);
fbMotionStage_x_dwn (stMotionStage:=M2);
fbMotionStage_pitch (stMotionStage:=M5);
fbMotionStage_bender (stMotionStage:=M6);]]></ST>
    </Implementation>
    <LineIds Name="Main">
      <LineId Id="3" Count="3" />
      <LineId Id="104" Count="3" />
      <LineId Id="7" Count="0" />
      <LineId Id="181" Count="18" />
      <LineId Id="108" Count="0" />
      <LineId Id="200" Count="0" />
      <LineId Id="8" Count="48" />
      <LineId Id="2" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>